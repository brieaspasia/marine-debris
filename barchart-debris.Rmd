---
title: "BarChart-Debris"
author: "Brie Sherow"
date: "04/08/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-libraries, echo=FALSE, include=FALSE}
lib.load = c("here", "ggplot2", "dplyr", "lubridate", "forcats", "plyr", "reshape2") 
lapply(lib.load, require, character.only = TRUE) 

```

```{r load-data}
data <- read.csv(file="data/all_data.csv", header=T, sep=",")
data$Date <- dmy(data$Date)
data$Notes <- as.character(data$Notes)

site_select <- data %>%
  filter(Team=="UNSW" & Location %in% c("DOUBL","WATSO","PARSL","NEUTR","CLIFT","ATHOL")) %>%
  select(-Habitat2, -Fragment, -Whole)

```

```{r load-item-code}
item_code <- read.csv(file="data/CSIRO-code.csv", header=T, sep=",")
```

```{r item-counts}
#normalise sites
site_total_item <- site_select %>%
  group_by(Site, ID) %>%
  mutate(mean=sum(Total)/NumberSurveys, #mean of item type per site
         mean_sd=sd(Total)) %>% #sd of item type per site
        ungroup()

site_total_item <- site_total_item %>%
  select(Location, Habitat, Site, ID, mean, mean_sd) %>%
  filter(mean > 0) %>%
  distinct()
  
site_total_item <- left_join(site_total_item, item_code, by="ID")

top_items_per_site <- site_total %>% group_by(Site) %>% top_n(3, mean)
``` 

```{r material-counts}
#normalise sites
site_total_mat <- site_select %>%
  group_by(Site, Material) %>%
  summarise(mean=mean(Total), #mean of item type per site
         mean_sd=sd(Total)) %>% #sd of item type per site
        ungroup()

# plyr version of the same thing:
site_total_mat <- ddply(site_select,
                        .(Site, Material), # group by these factors
                        summarise,
                        mean=mean(Total),
                        sd=sd(Total)
                        )

site_total_mat <- site_total_mat %>%
  select(Location, Habitat, Site, Material, mean, mean_sd) %>%
  filter(mean > 0) %>%
  distinct()

#not working...
# var_change <- c("Rubber", "Timber", "Cloth", "Ceramic", "Undetermined", "E-Waste", "Paper", "Brick or Cement")
# 
# site_total_mat$Material[site_total_mat$Material %in% var_change] = "Other"

top_mat_per_site <- site_total_mat %>% group_by(Site) %>% top_n(2, mean)

``` 
        
```{r pier-items}
P <- site_select %>%
  filter(Habitat=="P")

total_P <- P %>%
  group_by(Site, ID) %>%
  summarise(item_total=sum(Total),
            mean=item_total/NumberSurveys) %>%
  arrange(desc(mean))

total_P <- distinct(total_P)
total_P <- left_join(total_P, item_code, by="ID")

total_P <- total_P %>%
  filter(mean>2)

total_P %>%
  mutate(item_name=fct_reorder(item_name,desc(mean))) %>%
  ggplot( aes(x=item_name, y=mean, fill=Material)) +
  geom_col() +
  coord_flip() +
  facet_wrap(~Site)
```


```{r sediment-items}
SS <- site_select %>%
  filter(Habitat=="SS")

total_SS <- SS %>%
  group_by(Site, ID) %>%
  summarise(item_total=sum(Total),
            mean=item_total/NumberSurveys) %>%
  arrange(desc(mean))

total_SS <- distinct(total_SS)
total_SS <- left_join(total_SS, item_code, by="ID")

total_SS <- total_SS %>%
  filter(mean>2)

total_SS %>%
  mutate(item_name=fct_reorder(item_name,desc(mean))) %>%
  ggplot( aes(x=item_name, y=mean, fill=Material)) +
  geom_col() +
  coord_flip() +
  facet_wrap(~Site)
```
```{r fishing}
fishing <- site_select %>%
  group_by(Site, Fishing) %>%
  summarise(item_total=sum(Total),
            mean=item_total/NumberSurveys) %>%
  arrange(desc(mean))

fishing <- distinct(fishing)

site_habitat <- select(site_select, c(Site, Habitat, Location))
site_habitat <- distinct(site_habitat)
fishing <- left_join(fishing, site_habitat, by="Site")

fishing %>%
  ggplot( aes(x=Fishing, y=mean, fill=Location)) +
  geom_bar(position="dodge", stat="identity") +
  facet_wrap(~Habitat)

fishing %>%
  ggplot( aes(x=Habitat, y=mean, fill=Fishing)) +
  geom_bar(position="stack", stat="identity") +
  facet_wrap(~Location)
```

